#!/usr/bin/env bash
set -euo pipefail
session_dir="$HOME/.config/tmux/session-scripts"

# Pick realpath implementation. In the case of MacOS grealpath is equivalent to the one linux uses
realpath_cmd=$(command -v grealpath || command -v realpath)

# Read existing tmux sessions into an array and a lookup table
mapfile -t tmux_sessions < <(tmux list-sessions -F '#S' 2>/dev/null || true)

declare -A session_set
for s in "${tmux_sessions[@]}"; do
    session_set["$s"]=1
done

# Format for fzf: prepend *
existing_sessions=()
for s in "${tmux_sessions[@]}"; do
    existing_sessions+=("*$s")
done

# Collect scripts relative to session_dir, excluding .gitkeep
mapfile -t scripts < <(
    find "$session_dir" -type f ! -iname ".gitkeep" \
        -exec "$realpath_cmd" --relative-to="$session_dir" {} \;
)

# Filter scripts that already have sessions
filtered_scripts=()
for s in "${scripts[@]}"; do
    name="${s##*/}"
    if [[ -z ${session_set["$name"]+x} ]]; then
        filtered_scripts+=("$s")
    fi
done

# Build fzf menu
session_options=()

# Existing sessions first (blue)
for s in "${existing_sessions[@]}"; do
    session_options+=($'\033[1;34m'"$s"$'\033[0m')
done

# Then scripts
session_options+=("${filtered_scripts[@]}")

# Kill option last (red)
session_options+=($'\033[31mKill Session\033[0m')

# Pick selection
session=$(printf '%s\n' "${session_options[@]}" |
    fzf --ansi --header="Pick a session or 'Kill Session'" || echo '')

# Strip ANSI colors for logic
clean_session=$(sed 's/\x1b\[[0-9;]*m//g' <<<"$session")

if [[ "$clean_session" == "Kill Session" ]]; then
    sessions_to_kill=$(printf '%s\n' "${existing_sessions[@]}" |
        fzf --multi --header="Select sessions to kill" || echo '')

    [[ -z "$sessions_to_kill" ]] && exit 0

    # Extract names
    mapfile -t kill_list < <(sed 's/^\*//' <<<"$sessions_to_kill")

    printf "Kill session(s): \033[33m%s\033[0m? (y/n): " \
        "$(printf '%s, ' "${kill_list[@]}" | sed 's/, $//')"

    read -r confirm
    [[ "$confirm" =~ ^[yY]$ ]] || exit 0

    for s in "${kill_list[@]}"; do
        tmux kill-session -t "$s"
        echo "Session '$s' killed."
    done
else
    [[ -z "$clean_session" ]] && exit 0

    script_path="$session_dir/$clean_session"

    session_name="${clean_session##*/}"
    session_name="${session_name//env\//}"

    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        if [[ -f "$script_path" ]]; then
            session_name="$("$script_path")"
        else
            echo "Can't find session script: '$script_path'"
            exit 1
        fi
    fi

    if [[ -n "${TMUX:-}" ]]; then
        tmux switch -t "$session_name"
    else
        tmux attach -t "$session_name"
    fi
fi
